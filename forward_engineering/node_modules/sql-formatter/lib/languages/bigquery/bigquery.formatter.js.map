{"version":3,"file":"bigquery.formatter.js","names":["reservedSelect","expandPhrases","reservedCommands","reservedSetOperations","reservedJoins","reservedPhrases","BigQueryFormatter","Tokenizer","reservedDependentClauses","reservedKeywords","keywords","reservedFunctionNames","functions","extraParens","stringTypes","quote","prefixes","requirePrefix","identTypes","identChars","dashes","paramTypes","positional","named","quoted","lineCommentTypes","operators","postProcess","Formatter","tokens","detectArraySubscripts","combineParameterizedTypes","prevToken","EOF_TOKEN","map","token","text","type","TokenType","RESERVED_FUNCTION_NAME","processed","i","length","isToken","ARRAY","STRUCT","endIndex","findClosingAngleBracketIndex","typeDefTokens","slice","push","IDENTIFIER","raw","formatTypeDefToken","join","start","end","t","reduce","a","b","key","COMMA","startIndex","level"],"sources":["../../../src/languages/bigquery/bigquery.formatter.ts"],"sourcesContent":["import Formatter from 'src/formatter/Formatter';\nimport Tokenizer from 'src/lexer/Tokenizer';\nimport { EOF_TOKEN, isToken, TokenType, Token } from 'src/lexer/token';\nimport { expandPhrases } from 'src/expandPhrases';\nimport { keywords } from './bigquery.keywords';\nimport { functions } from './bigquery.functions';\n\nconst reservedSelect = expandPhrases(['SELECT [ALL | DISTINCT] [AS STRUCT | AS VALUE]']);\n\nconst reservedCommands = expandPhrases([\n  // Queries: https://cloud.google.com/bigquery/docs/reference/standard-sql/query-syntax\n  'WITH [RECURSIVE]',\n  'FROM',\n  'WHERE',\n  'GROUP BY',\n  'HAVING',\n  'QUALIFY',\n  'WINDOW',\n  'PARTITION BY',\n  'ORDER BY',\n  'LIMIT',\n  'OFFSET',\n  'OMIT RECORD IF', // legacy\n  // Data modification: https://cloud.google.com/bigquery/docs/reference/standard-sql/dml-syntax\n  // - insert:\n  'INSERT [INTO]',\n  'VALUES',\n  // - update:\n  'UPDATE',\n  'SET',\n  // - delete:\n  'DELETE [FROM]',\n  // - truncate:\n  'TRUNCATE TABLE',\n  // - merge:\n  'MERGE [INTO]',\n  'WHEN [NOT] MATCHED [BY SOURCE | BY TARGET] [THEN]',\n  'UPDATE SET',\n  // Data definition, https://cloud.google.com/bigquery/docs/reference/standard-sql/data-definition-language\n  'CREATE [OR REPLACE] [MATERIALIZED] VIEW [IF NOT EXISTS]',\n  'CREATE [OR REPLACE] [TEMP|TEMPORARY|SNAPSHOT|EXTERNAL] TABLE [IF NOT EXISTS]',\n  'DROP [SNAPSHOT | EXTERNAL] TABLE [IF EXISTS]',\n  // - alter table:\n  'ALTER TABLE [IF EXISTS]',\n  'ADD COLUMN [IF NOT EXISTS]',\n  'DROP COLUMN [IF EXISTS]',\n  'RENAME TO',\n  'ALTER COLUMN [IF EXISTS]',\n  'SET DEFAULT COLLATE', // for alter column\n  'SET OPTIONS', // for alter column\n  'DROP NOT NULL', // for alter column\n  'SET DATA TYPE', // for alter column\n\n  'CREATE SCHEMA [IF NOT EXISTS]',\n  'DEFAULT COLLATE',\n  'CLUSTER BY',\n  'FOR SYSTEM_TIME AS OF', // CREATE SNAPSHOT TABLE\n  'WITH CONNECTION',\n  'WITH PARTITION COLUMNS',\n  'CREATE [OR REPLACE] [TEMP|TEMPORARY|TABLE] FUNCTION [IF NOT EXISTS]',\n  'REMOTE WITH CONNECTION',\n  'RETURNS TABLE',\n  'CREATE [OR REPLACE] PROCEDURE [IF NOT EXISTS]',\n  'CREATE [OR REPLACE] ROW ACCESS POLICY [IF NOT EXISTS]',\n  'GRANT TO',\n  'FILTER USING',\n  'CREATE CAPACITY',\n  'AS JSON',\n  'CREATE RESERVATION',\n  'CREATE ASSIGNMENT',\n  'CREATE SEARCH INDEX [IF NOT EXISTS]',\n  'ALTER SCHEMA [IF EXISTS]',\n\n  'ALTER [MATERIALIZED] VIEW [IF EXISTS]',\n  'ALTER BI_CAPACITY',\n  'DROP SCHEMA [IF EXISTS]',\n  'DROP [MATERIALIZED] VIEW [IF EXISTS]',\n  'DROP [TABLE] FUNCTION [IF EXISTS]',\n  'DROP PROCEDURE [IF EXISTS]',\n  'DROP ROW ACCESS POLICY',\n  'DROP ALL ROW ACCESS POLICIES',\n  'DROP CAPACITY [IF EXISTS]',\n  'DROP RESERVATION [IF EXISTS]',\n  'DROP ASSIGNMENT [IF EXISTS]',\n  'DROP SEARCH INDEX [IF EXISTS]',\n  'DROP [IF EXISTS]',\n  // DCL, https://cloud.google.com/bigquery/docs/reference/standard-sql/data-control-language\n  'GRANT',\n  'REVOKE',\n  // Script, https://cloud.google.com/bigquery/docs/reference/standard-sql/scripting\n  'DECLARE',\n  'EXECUTE IMMEDIATE',\n  'LOOP',\n  'END LOOP',\n  'REPEAT',\n  'END REPEAT',\n  'WHILE',\n  'END WHILE',\n  'BREAK',\n  'LEAVE',\n  'CONTINUE',\n  'ITERATE',\n  'FOR',\n  'END FOR',\n  'BEGIN',\n  'BEGIN TRANSACTION',\n  'COMMIT TRANSACTION',\n  'ROLLBACK TRANSACTION',\n  'RAISE',\n  'RETURN',\n  'CALL',\n  // Debug, https://cloud.google.com/bigquery/docs/reference/standard-sql/debugging-statements\n  'ASSERT',\n  // Other, https://cloud.google.com/bigquery/docs/reference/standard-sql/other-statements\n  'EXPORT DATA',\n]);\n\nconst reservedSetOperations = expandPhrases([\n  'UNION {ALL | DISTINCT}',\n  'EXCEPT DISTINCT',\n  'INTERSECT DISTINCT',\n]);\n\nconst reservedJoins = expandPhrases([\n  'JOIN',\n  '{LEFT | RIGHT | FULL} [OUTER] JOIN',\n  '{INNER | CROSS} JOIN',\n]);\n\nconst reservedPhrases = expandPhrases([\n  // https://cloud.google.com/bigquery/docs/reference/standard-sql/query-syntax#tablesample_operator\n  'TABLESAMPLE SYSTEM',\n  // From DDL: https://cloud.google.com/bigquery/docs/reference/standard-sql/data-definition-language\n  'ANY TYPE',\n  'ALL COLUMNS',\n  'NOT DETERMINISTIC',\n  // inside window definitions\n  '{ROWS | RANGE} BETWEEN',\n]);\n\n// https://cloud.google.com/bigquery/docs/reference/#standard-sql-reference\nexport default class BigQueryFormatter extends Formatter {\n  // TODO: handle trailing comma in select clause\n  tokenizer() {\n    return new Tokenizer({\n      reservedCommands,\n      reservedSelect,\n      reservedSetOperations,\n      reservedJoins,\n      reservedDependentClauses: ['WHEN', 'ELSE'],\n      reservedPhrases,\n      reservedKeywords: keywords,\n      reservedFunctionNames: functions,\n      extraParens: ['[]'],\n      stringTypes: [\n        // The triple-quoted strings are listed first, so they get matched first.\n        // Otherwise the first two quotes of \"\"\" will get matched as an empty \"\" string.\n        { quote: '\"\"\"..\"\"\"', prefixes: ['R', 'B', 'RB', 'BR'] },\n        { quote: \"'''..'''\", prefixes: ['R', 'B', 'RB', 'BR'] },\n        '\"\"-bs',\n        \"''-bs\",\n        { quote: '\"\"-raw', prefixes: ['R', 'B', 'RB', 'BR'], requirePrefix: true },\n        { quote: \"''-raw\", prefixes: ['R', 'B', 'RB', 'BR'], requirePrefix: true },\n      ],\n      identTypes: ['``'],\n      identChars: { dashes: true },\n      paramTypes: { positional: true, named: ['@'], quoted: ['@'] },\n      lineCommentTypes: ['--', '#'],\n      operators: ['&', '|', '^', '~', '>>', '<<', '||'],\n      postProcess,\n    });\n  }\n}\n\nfunction postProcess(tokens: Token[]): Token[] {\n  return detectArraySubscripts(combineParameterizedTypes(tokens));\n}\n\n// Converts OFFSET token inside array from RESERVED_COMMAND to RESERVED_FUNCTION_NAME\n// See: https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators#array_subscript_operator\nfunction detectArraySubscripts(tokens: Token[]) {\n  let prevToken = EOF_TOKEN;\n  return tokens.map(token => {\n    if (token.text === 'OFFSET' && prevToken.text === '[') {\n      prevToken = token;\n      return { ...token, type: TokenType.RESERVED_FUNCTION_NAME };\n    } else {\n      prevToken = token;\n      return token;\n    }\n  });\n}\n\n// Combines multiple tokens forming a parameterized type like STRUCT<ARRAY<INT64>> into a single token\nfunction combineParameterizedTypes(tokens: Token[]) {\n  const processed: Token[] = [];\n  for (let i = 0; i < tokens.length; i++) {\n    const token = tokens[i];\n\n    if ((isToken.ARRAY(token) || isToken.STRUCT(token)) && tokens[i + 1]?.text === '<') {\n      const endIndex = findClosingAngleBracketIndex(tokens, i + 1);\n      const typeDefTokens = tokens.slice(i, endIndex + 1);\n      processed.push({\n        type: TokenType.IDENTIFIER,\n        raw: typeDefTokens.map(formatTypeDefToken('raw')).join(''),\n        text: typeDefTokens.map(formatTypeDefToken('text')).join(''),\n        start: token.start,\n        end: token.end + typeDefTokens.map(t => t.text.length).reduce((a, b) => a + b),\n      });\n      i = endIndex;\n    } else {\n      processed.push(token);\n    }\n  }\n  return processed;\n}\n\nconst formatTypeDefToken =\n  (key: Extract<keyof Token, 'raw' | 'text'>) =>\n  (token: Token): string => {\n    if (token.type === TokenType.IDENTIFIER || token.type === TokenType.COMMA) {\n      return token[key] + ' ';\n    } else {\n      return token[key];\n    }\n  };\n\nfunction findClosingAngleBracketIndex(tokens: Token[], startIndex: number): number {\n  let level = 0;\n  for (let i = startIndex; i < tokens.length; i++) {\n    const token = tokens[i];\n    if (token.text === '<') {\n      level++;\n    } else if (token.text === '>') {\n      level--;\n    } else if (token.text === '>>') {\n      level -= 2;\n    }\n    if (level === 0) {\n      return i;\n    }\n  }\n  return tokens.length - 1;\n}\n"],"mappings":"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"}